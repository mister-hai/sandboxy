version: "3"
#################################################################
##
## THIS FILE CONTAINS THE ENTRIES FOR THE INFRASTRUCTURE
##
## container port mapping to avoid confuflict
##   LOGINPORT=8080
#3   BWAPPPORT=
##   WEEBGOATPORT=
##   DVWAPORT=
##   MUTILLIDAE2PORT=
##   CTFDPORT=
#################################################################
services:
#################################################################
##  Parrotsec/ParOS
#################################################################
    parrot:
      image: parrotsec/security
      volumes:
        - "/run/docker.sock:/var/run/docker.sock"
      networks:
        net:
          ipv4_address: 172.18.0.2
      #volumes:
      #  -  /tmp/msf:/tmp/data:Z
      #network_mode: host
#################################################################
##  NGINX ; proxies to the other containers
# DEPRECATED in favor of TRAEFIK currently
#################################################################        
    nginx:
      build:
        context: ./containers/nginx
        dockerfile: Dockerfile
      image: nginx:latest
      depends_on:
        - bwapp
        - dvwa
        - ctfd
      restart: unless-stopped
      env_file:
        - ./.env
      ports:
      - 80:80
      - 443:443
      environment: 
        NGINX_ENVSUBST_TEMPLATE_SUFFIX: ".template"
        NGINX_ENVSUBST_TEMPLATE_DIR: "/etc/nginx"
        NGINX_ENVSUBST_OUTPUT_DIR: "/etc/nginx"
      volumes:
        #- ./data/certbot/conf:/etc/letsencrypt
        #- ./data/certbot/www:/var/www/certbot
        - "/run/docker.sock:/var/run/docker.sock"
      #  - ./confs/nginx.conf:/etc/nginx/nginx.conf
      hostname: nginx
      networks:
        net:
          ipv4_address: 172.18.0.3

################################################################
## CERTBOT
################################################################
#    certbot:
#      image: certbot/certbot
#      hostname: certbot
#      #volumes:
#        #- ./data/certbot/conf:/etc/letsencrypt
#        #- ./data/certbot/www:/var/www/certbot
#      networks:
#        net:
#          ipv4_address: 172.18.0.4
#################################################################
##  BWAPP   ; will be locked down for semi-private usage
#################################################################
    bwapp:
      image: raesene/bwapp
      expose:
        - 80
      ports:
        - 8081:80
      networks:
        net:
          ipv4_address: 172.18.0.5
      hostname: bwapp
##################################################################
##        WEB GOAT AND WOLF  ; will be locked down for semi-private usage
#################################################################
#    webgoat:
#      image: webgoat/webgoat-7.1
#      #expose:
#      #  - ${WEEBGOATPORT}
#      restart: unless-stopped
#      ports:
#        - ${WEEBGOATPORT}:8080
#      networks:
#        - net
#################################################################
##  Damn Vulnerable WEB APP ; will be locked down for semi-private usage
#################################################################
    dvwa:
      image: vulnerables/web-dvwa
      hostname: dvwa
      expose:
        - 80
      restart: unless-stopped
      ports:
        - 8082:80
      networks:
        net:
          ipv4_address: 172.18.0.6
        
#################################################################
##  Mutillidae2 ; will be locked down for semi-private usage
#################################################################
#    mutillidae2:
#      image: santosomar/mutillidae_2
#      #expose:
#      #  - ${MUTILLIDAE2PORT}
#      restart: unless-stopped
#      #ports:
#      #  - ${MUTILLIDAE2PORT}:80
#      networks:
#        - net
#################################################################
##  CTFD; part of the network game, will allow network pivoting
## will use the builder script portion for production. 
#################################################################        
    ctfd:
      image: ctfd/ctfd
      hostname: ctfd
      expose:
        - 8000
      restart: unless-stopped
      ports:
        - 8000:8000
      #network_mode: host
      networks:
        net:
          ipv4_address: 172.18.0.7

#################################################################
#     NETWORKS SECTION
#################################################################      
#networks:
#  macvlan:
networks:
  net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.18.0.0/24